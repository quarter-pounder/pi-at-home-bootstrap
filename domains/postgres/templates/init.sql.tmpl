DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_roles WHERE rolname = '{{ POSTGRES_USER_FORGEJO }}'
  ) THEN
    CREATE ROLE {{ POSTGRES_USER_FORGEJO }} LOGIN PASSWORD '{{ POSTGRES_PASSWORD_FORGEJO }}';
  END IF;
END
$$;

SELECT 'CREATE DATABASE {{ POSTGRES_DB_FORGEJO }} OWNER {{ POSTGRES_USER_FORGEJO }} TEMPLATE template0 ENCODING ''UTF8'''
WHERE NOT EXISTS (
  SELECT 1 FROM pg_database WHERE datname = '{{ POSTGRES_DB_FORGEJO }}'
);
\gexec

\connect {{ POSTGRES_DB_FORGEJO }}
GRANT ALL PRIVILEGES ON DATABASE {{ POSTGRES_DB_FORGEJO }} TO {{ POSTGRES_USER_FORGEJO }};
ALTER SCHEMA public OWNER TO {{ POSTGRES_USER_FORGEJO }};
GRANT ALL PRIVILEGES ON SCHEMA public TO {{ POSTGRES_USER_FORGEJO }};
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON TABLES TO {{ POSTGRES_USER_FORGEJO }};
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON SEQUENCES TO {{ POSTGRES_USER_FORGEJO }};

\connect postgres

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_roles WHERE rolname = '{{ POSTGRES_USER_WOODPECKER }}'
  ) THEN
    CREATE ROLE {{ POSTGRES_USER_WOODPECKER }} LOGIN PASSWORD '{{ POSTGRES_PASSWORD_WOODPECKER }}';
  END IF;
END
$$;

SELECT 'CREATE DATABASE {{ POSTGRES_DB_WOODPECKER }} OWNER {{ POSTGRES_USER_WOODPECKER }} TEMPLATE template0 ENCODING ''UTF8'''
WHERE NOT EXISTS (
  SELECT 1 FROM pg_database WHERE datname = '{{ POSTGRES_DB_WOODPECKER }}'
);
\gexec

\connect {{ POSTGRES_DB_WOODPECKER }}
GRANT ALL PRIVILEGES ON DATABASE {{ POSTGRES_DB_WOODPECKER }} TO {{ POSTGRES_USER_WOODPECKER }};
ALTER SCHEMA public OWNER TO {{ POSTGRES_USER_WOODPECKER }};
GRANT ALL PRIVILEGES ON SCHEMA public TO {{ POSTGRES_USER_WOODPECKER }};
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON TABLES TO {{ POSTGRES_USER_WOODPECKER }};
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON SEQUENCES TO {{ POSTGRES_USER_WOODPECKER }};

\connect postgres

