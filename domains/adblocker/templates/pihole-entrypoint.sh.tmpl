#!/bin/sh
set -e

# Wait a moment for network to be ready
sleep 3

echo "[i] Resolving unbound IP..."
UNBOUND_IP=""

# Method 1: Try getent (works with Docker's embedded DNS)
if command -v getent >/dev/null 2>&1; then
  for name in unbound adblocker-unbound; do
    UNBOUND_IP=$(getent hosts "$name" 2>/dev/null | awk 'NR==1 {print $1}' || true)
    if [ -n "$UNBOUND_IP" ] && [ "$UNBOUND_IP" != "127.0.0.1" ] && [ "$UNBOUND_IP" != "::1" ]; then
      break
    fi
  done
fi

# Method 2: Try reading from /etc/hosts (Docker populates this)
if [ -z "$UNBOUND_IP" ] && [ -f /etc/hosts ]; then
  UNBOUND_IP=$(grep -E "^(172|10|192)\." /etc/hosts | grep -E "(unbound|adblocker-unbound)" | awk '{print $1}' | head -n1 || true)
fi

# Method 3: Try using dig if available
if [ -z "$UNBOUND_IP" ] && command -v dig >/dev/null 2>&1; then
  UNBOUND_IP=$(dig +short unbound @127.0.0.11 2>/dev/null | grep -E "^([0-9]{1,3}\.){3}[0-9]{1,3}$" | head -n1 || true)
fi

# Method 4: Try ping (last resort)
if [ -z "$UNBOUND_IP" ] && command -v ping >/dev/null 2>&1; then
  for name in unbound adblocker-unbound; do
    PING_OUTPUT=$(timeout 2 ping -c 1 "$name" 2>&1 || true)
    UNBOUND_IP=$(echo "$PING_OUTPUT" | grep -oE '\(([0-9]{1,3}\.){3}[0-9]{1,3}\)' | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1 || true)
    if [ -n "$UNBOUND_IP" ]; then
      break
    fi
  done
fi

if [ -n "$UNBOUND_IP" ] && [ "$UNBOUND_IP" != "127.0.0.1" ] && [ "$UNBOUND_IP" != "::1" ]; then
  echo "[i] Resolved unbound IP: $UNBOUND_IP"
  export PIHOLE_DNS_="${UNBOUND_IP}#53;1.1.1.1;1.0.0.1"
  export DNS1="${UNBOUND_IP}#53"
else
  echo "[!] Warning: Could not resolve unbound IP, using fallback DNS"
  export PIHOLE_DNS_="1.1.1.1;1.0.0.1"
  export DNS1="1.1.1.1"
fi

if [ -f "/init" ]; then
  exec /init "$@"
elif [ -f "/s6-init" ]; then
  exec /s6-init "$@"
elif [ -f "/usr/local/bin/_entrypoint.sh" ]; then
  exec /usr/local/bin/_entrypoint.sh "$@"
else
  echo "[!] Error: Could not find Pi-hole entrypoint"
  exit 1
fi

