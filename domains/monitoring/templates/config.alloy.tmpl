discovery.docker "containers" {
  host = "unix:///var/run/docker.sock"
}

local.file_match "system_logs" {
  path_targets = [
    { __path__ = "/var/log/syslog",   job = "system", service = "syslog" },
    { __path__ = "/var/log/auth.log", job = "system", service = "auth"   },
    { __path__ = "/var/log/kern.log", job = "system", service = "kernel" },
  ]
}

local.file_match "forgejo_logs" {
  path_targets = [
    { __path__ = "/srv/forgejo/log/forgejo.log", job = "forgejo", service = "web"   },
    { __path__ = "/srv/forgejo/log/hooks.log",   job = "forgejo", service = "hooks" },
    { __path__ = "/srv/forgejo/log/http.log",    job = "forgejo", service = "http"  },
  ]
}

/* ----- SYSTEM LOGS ----- */
loki.source.file "system" {
  targets    = local.file_match.system_logs.targets
  forward_to = [loki.process.system.receiver]
}

loki.process "system" {
  forward_to = [loki.write.default.receiver]

  stage.regex {
    expression = "^(?P<timestamp>[^ ]+ [^ ]+) (?P<hostname>[^ ]+) (?P<service>[^:]+): (?P<message>.*)$"
  }

  stage.labels {
    values = {
      job     = "{{ .job }}",
      service = "{{ .service }}",
      source  = "system",
    }
  }

  stage.timestamp {
    source = "timestamp"
    format = "Jan 02 15:04:05"
  }
}

/* ----- FORGEJO ----- */
loki.source.file "forgejo" {
  targets    = local.file_match.forgejo_logs.targets
  forward_to = [loki.process.forgejo.receiver]
}

loki.process "forgejo" {
  forward_to = [loki.write.default.receiver]

  stage.json {
    expressions = {
      timestamp = "time",
      message   = "message",
      level     = "severity",
    }
  }

  stage.labels {
    values = {
      job     = "{{ .job }}",
      service = "{{ .service }}",
      source  = "forgejo",
    }
  }

  stage.timestamp {
    source = "timestamp"
    format = "2006-01-02T15:04:05.000Z"
  }
}

/* ----- DOCKER CONTAINERS (SAFE VERSION) ----- */
loki.source.docker "containers" {
  host       = "unix:///var/run/docker.sock"
  targets    = discovery.docker.containers.targets
  forward_to = [loki.process.docker.receiver]
}

loki.process "docker" {
  forward_to = [loki.write.default.receiver]

  stage.labels {
    values = {
      job     = "docker",
      source  = "containers",
    }
  }

  stage.json {
    expressions = {
      timestamp = "time",
      message   = "log",
      level     = "level",
      container = "attrs.name",
      service   = "attrs.labels.\"com.docker.compose.service\"",
      stack     = "attrs.labels.\"com.docker.compose.project\"",
    }
  }

  stage.timestamp {
    source = "timestamp"
    format = "2006-01-02T15:04:05.000000000Z"
  }
}

/* ----- LOKI WRITE ----- */
loki.write "default" {
  endpoint {
    url = "http://monitoring-loki:3100/loki/api/v1/push"
  }
}
