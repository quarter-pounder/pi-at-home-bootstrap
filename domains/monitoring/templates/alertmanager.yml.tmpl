{% set smtp_host = SMTP_ADDRESS if SMTP_ADDRESS else 'localhost' %}
{% set smtp_port = SMTP_PORT if SMTP_PORT else '25' %}
{% set smtp_from = SMTP_FROM if SMTP_FROM else ('alerts@' ~ (DOMAIN if DOMAIN else 'local')) %}
{% set default_webhook = DR_WEBHOOK_URL if DR_WEBHOOK_URL else 'http://localhost:8081/webhook' %}
{% set webhook_token = DR_WEBHOOK_TOKEN if DR_WEBHOOK_TOKEN else '' %}

global:
  smtp_smarthost: '{{ smtp_host }}:{{ smtp_port }}'
  smtp_from: '{{ smtp_from }}'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'webhook'
  routes:
{% if DR_WEBHOOK_URL %}
    - match:
        action: trigger_dr
      receiver: 'dr-webhook'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m
    - match:
        action: recover_dr
      receiver: 'dr-webhook'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 5m
{% endif %}

receivers:
  - name: 'webhook'
    webhook_configs:
      - url: '{{ default_webhook }}'
        send_resolved: true
{% if webhook_token %}
        http_config:
          bearer_token: '{{ webhook_token }}'
{% endif %}

{% if DR_WEBHOOK_URL %}
  - name: 'dr-webhook'
    webhook_configs:
      - url: '{{ DR_WEBHOOK_URL }}'
        send_resolved: true
{% if webhook_token %}
        http_config:
          bearer_token: '{{ webhook_token }}'
{% endif %}
{% endif %}

{% if ALERT_EMAIL %}
  - name: 'email'
    email_configs:
      - to: '{{ ALERT_EMAIL }}'
        subject: '{% raw %}Forgejo Pi Alert: {{ .GroupLabels.alertname }}{% endraw %}'
        body: |
{% raw %}          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          {{ end }}
{% endraw %}
{% endif %}
