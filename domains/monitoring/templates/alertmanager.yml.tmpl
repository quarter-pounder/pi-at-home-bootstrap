{% set smtp_host = SMTP_ADDRESS if SMTP_ADDRESS else 'localhost' %}
{% set smtp_port = SMTP_PORT if SMTP_PORT else '25' %}
{% set smtp_from = SMTP_FROM if SMTP_FROM else ('alerts@' ~ (DOMAIN if DOMAIN else 'local')) %}
{% set smtp_username = SMTP_USERNAME|default('') %}
{% set smtp_password = SMTP_PASSWORD|default('') %}
{% set smtp_domain = SMTP_DOMAIN|default('localhost') %}
{% set smtp_auth = SMTP_AUTH|default('none') %}
{% set smtp_has_auth = smtp_username and smtp_password %}
{% set dr_url = (DR_WEBHOOK_URL|default('')) %}
{% set dr_enabled = dr_url|length > 0 %}
{% set primary_receiver = 'dr-webhook' if dr_enabled else ('email' if ALERT_EMAIL else 'null') %}
{% set webhook_token = DR_WEBHOOK_TOKEN|default('') %}

global:
  smtp_smarthost: '{{ smtp_host }}:{{ smtp_port }}'
  smtp_from: '{{ smtp_from }}'
{% if smtp_has_auth %}
  smtp_auth_username: '{{ smtp_username }}'
  smtp_auth_password: '{{ smtp_password }}'
  smtp_auth_secret: '{{ smtp_password }}'
{% endif %}
  smtp_hello: '{{ smtp_domain }}'
{% if SMTP_STARTTLS|default('false') == 'true' %}
  smtp_require_tls: true
{% endif %}

inhibit_rules:
  - source_match:
      alertname: RunnerSuppressionActive
      alert_type: suppression
    target_match:
      alertname: RunnerContainerDown
      alert_type: runner
    equal: ['runner_name']

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: '{{ primary_receiver }}'
  routes:
{% if dr_enabled %}
    - match:
        action: trigger_dr
      receiver: 'dr-webhook'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m
    - match:
        action: recover_dr
      receiver: 'dr-webhook'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 5m
{% endif %}

receivers:
{% if dr_enabled %}
  - name: 'dr-webhook'
    webhook_configs:
      - url: '{{ DR_WEBHOOK_URL }}'
        send_resolved: true
{% if webhook_token %}
        http_config:
          bearer_token: '{{ webhook_token }}'
{% endif %}
{% endif %}
{% if ALERT_EMAIL %}
  - name: 'email'
    email_configs:
      - to: '{{ ALERT_EMAIL }}'
        subject: '{% raw %}Forgejo Pi Alert: {{ .GroupLabels.alertname }}{% endraw %}'
        body: |
{% raw %}          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          {{ end }}
{% endraw %}
{% endif %}
  - name: 'null'
    webhook_configs:
      - url: 'http://127.0.0.1:0'
        send_resolved: false
