{% set smtp_host = SMTP_ADDRESS if SMTP_ADDRESS else 'localhost' %}
{% set smtp_port = SMTP_PORT if SMTP_PORT else '25' %}
{% set smtp_from = SMTP_FROM if SMTP_FROM else ('alerts@' ~ (DOMAIN if DOMAIN else 'local')) %}
{% set dr_enabled = DR_WEBHOOK_URL is not none and DR_WEBHOOK_URL|length > 0 %}
{% set primary_receiver = 'dr-webhook' if dr_enabled else ('email' if ALERT_EMAIL else 'null') %}
{% set webhook_token = DR_WEBHOOK_TOKEN if DR_WEBHOOK_TOKEN else '' %}

global:
  smtp_smarthost: '{{ smtp_host }}:{{ smtp_port }}'
  smtp_from: '{{ smtp_from }}'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: '{{ primary_receiver }}'
  routes:
{% if dr_enabled %}
    - match:
        action: trigger_dr
      receiver: 'dr-webhook'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m
    - match:
        action: recover_dr
      receiver: 'dr-webhook'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 5m
{% endif %}

receivers:
{% if dr_enabled %}
  - name: 'dr-webhook'
    webhook_configs:
      - url: '{{ DR_WEBHOOK_URL }}'
        send_resolved: true
{% if webhook_token %}
        http_config:
          bearer_token: '{{ webhook_token }}'
{% endif %}
{% endif %}
{% if ALERT_EMAIL %}
  - name: 'email'
    email_configs:
      - to: '{{ ALERT_EMAIL }}'
        subject: '{% raw %}Forgejo Pi Alert: {{ .GroupLabels.alertname }}{% endraw %}'
        body: |
{% raw %}          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          {{ end }}
{% endraw %}
{% endif %}
  - name: 'null'
    webhook_configs:
      - url: 'http://127.0.0.1:0'
        send_resolved: false
