#!/bin/sh
set -eu

CONFIG="/data/gitea/conf/app.ini"
ADMIN_USER="${FORGEJO_ADMIN_USERNAME:-}"
ADMIN_PASS="${FORGEJO_ADMIN_PASSWORD:-}"
ADMIN_EMAIL="${FORGEJO_ADMIN_EMAIL:-}"
DB_HOST="${FORGEJO_DB_HOST:-forgejo-postgres}"
DB_PORT="${FORGEJO_DB_PORT:-5432}"
DB_NAME="${FORGEJO_DB_NAME:-forgejo}"
DB_USER="${FORGEJO_DB_USER:-forgejo}"
FORGEJO_BIN="/usr/local/bin/forgejo"

if [ -f /usr/local/bin/entrypoint ]; then
  . /usr/local/bin/entrypoint
fi

log() {
  echo "[forgejo-bootstrap] $*" >&2
}

wait_for_db() {
  retries=60
  attempt=1
  while [ "$retries" -gt 0 ]; do
    if OUTPUT=$("$FORGEJO_BIN" admin doctor check-db --config "$CONFIG" 2>&1); then
      return 0
    fi
    if [ "$attempt" -le 5 ] || [ "$retries" -le 3 ]; then
      log "db check attempt $attempt failed: $OUTPUT"
    fi
    sleep 2
    retries=$((retries - 1))
    attempt=$((attempt + 1))
  done
  return 1
}

if ! [ -f "$CONFIG" ]; then
  log "config $CONFIG not found; aborting"
  exit 1
fi

if [ -z "$ADMIN_USER" ] || [ -z "$ADMIN_PASS" ] || [ -z "$ADMIN_EMAIL" ]; then
  log "admin credentials incomplete; skipping bootstrap"
  exit 0
fi

log "Waiting for database $DB_USER@$DB_HOST:$DB_PORT/$DB_NAME"
if ! wait_for_db; then
  log "database is unreachable; aborting"
  exit 1
fi

if "$FORGEJO_BIN" admin user list --config "$CONFIG" 2>/dev/null | grep -q "^$ADMIN_USER"; then
  log "admin user already present; nothing to do"
  exit 0
fi

"$FORGEJO_BIN" admin user create \
  --config "$CONFIG" \
  --username "$ADMIN_USER" \
  --password "$ADMIN_PASS" \
  --email "$ADMIN_EMAIL" \
  --admin \
  --must-change-password=false >/dev/null

log "admin user $ADMIN_USER created"

