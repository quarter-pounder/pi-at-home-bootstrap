#!/bin/sh
set -eu

CONFIG="/data/gitea/conf/app.ini"
ADMIN_USER="${FORGEJO_ADMIN_USERNAME:-}"
ADMIN_PASS="${FORGEJO_ADMIN_PASSWORD:-}"
ADMIN_EMAIL="${FORGEJO_ADMIN_EMAIL:-}"
DB_HOST="${FORGEJO_DB_HOST:-forgejo-postgres}"
DB_PORT="${FORGEJO_DB_PORT:-5432}"
DB_NAME="${FORGEJO_DB_NAME:-forgejo}"
DB_USER="${FORGEJO_DB_USER:-forgejo}"

FORGEJO_BIN=""
for candidate in /usr/local/bin/forgejo /usr/bin/forgejo; do
  if [ -x "$candidate" ]; then
    FORGEJO_BIN="$candidate"
    break
  fi
done

if [ -z "$FORGEJO_BIN" ]; then
  echo "[forgejo-bootstrap] forgejo binary not found" >&2
  exit 1
fi

if [ -f /usr/local/bin/entrypoint ]; then
  . /usr/local/bin/entrypoint
fi

run_forgejo() {
  if command -v su-exec >/dev/null 2>&1; then
    su-exec forgejo "$FORGEJO_BIN" "$@"
  elif command -v runuser >/dev/null 2>&1; then
    runuser -u forgejo -- "$FORGEJO_BIN" "$@"
  elif command -v gosu >/dev/null 2>&1; then
    gosu forgejo "$FORGEJO_BIN" "$@"
  else
    su -s /bin/sh forgejo -c "\"$FORGEJO_BIN\" $*"
  fi
}

log() {
  echo "[forgejo-bootstrap] $*" >&2
}

wait_for_db() {
  retries=60
  attempt=1
  while [ "$retries" -gt 0 ]; do
    if OUTPUT=$(run_forgejo admin doctor check-db --config "$CONFIG" 2>&1); then
      return 0
    fi
    if [ "$attempt" -le 5 ] || [ "$retries" -le 3 ]; then
      log "db check attempt $attempt failed: $OUTPUT"
    fi
    sleep 2
    retries=$((retries - 1))
    attempt=$((attempt + 1))
  done
  return 1
}

if ! [ -f "$CONFIG" ]; then
  log "config $CONFIG not found; aborting"
  exit 1
fi

if [ -z "$ADMIN_USER" ] || [ -z "$ADMIN_PASS" ] || [ -z "$ADMIN_EMAIL" ]; then
  log "admin credentials incomplete; skipping bootstrap"
  exit 0
fi

log "Waiting for database $DB_USER@$DB_HOST:$DB_PORT/$DB_NAME"
if ! wait_for_db; then
  log "database is unreachable; aborting"
  exit 1
fi

if run_forgejo admin user list --config "$CONFIG" 2>/dev/null | grep -q "^$ADMIN_USER"; then
  log "admin user already present; nothing to do"
  exit 0
fi

run_forgejo admin user create \
  --config "$CONFIG" \
  --username "$ADMIN_USER" \
  --password "$ADMIN_PASS" \
  --email "$ADMIN_EMAIL" \
  --admin \
  --must-change-password=false >/dev/null

log "admin user $ADMIN_USER created"

